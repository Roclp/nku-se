# 计算机网络

![image-20231014150721941](https://s2.loli.net/2024/01/09/4VAYTlnUBMafpFt.png)

![image-20240109165652094](https://s2.loli.net/2024/01/09/XleYw6MaInv5uj1.png)![image-20240109165722956](https://s2.loli.net/2024/01/09/8rXZv7OtWT391cs.png)![image-20240109165813337](https://s2.loli.net/2024/01/09/TPZaOMnthBA194v.png)![image-20240109165823941](https://s2.loli.net/2024/01/09/gyjKReDcr3XVnLA.png)![image-20240109165912551](https://s2.loli.net/2024/01/09/F3iU9mjvZ264tzO.png)![image-20240109165928397](https://s2.loli.net/2024/01/09/GH2wBIMYX68a7gx.png)![image-20240109165942613](https://s2.loli.net/2024/01/09/PS9Tm3gfZN8abv5.png)![image-20240109170000040](https://s2.loli.net/2024/01/09/vdlXzQ82UfwpncL.png)![image-20240109170102686](https://s2.loli.net/2024/01/09/PDxcTK1eQb9pFME.png)![image-20240109170120562](https://s2.loli.net/2024/01/09/1kWXIPSHe3uBOyw.png)![image-20240109170136237](https://s2.loli.net/2024/01/09/UFc4JZIupKl2yDr.png)

![image-20240109171527543](https://s2.loli.net/2024/01/09/nC5sPVUolhzxLWY.png)![image-20240109173010896](https://s2.loli.net/2024/01/09/P45bzf9IAYZietD.png)![image-20240109173034585](https://s2.loli.net/2024/01/09/sGBNrY24dCuh3op.png)![image-20240109173150294](https://s2.loli.net/2024/01/09/5YGWLpsDMoEKURF.png)

![image-20240109173320781](https://s2.loli.net/2024/01/09/OfzQSlTFds7hY31.png)





标了 了解 不考



TCP 网络层 传输层



## 引言

### 网络的功能

网络提供的最基本服务：信息传递

不同的网络用什么区分：所提供的服务

服务用什么区分：

- 功能、延迟、带宽、丢失率
- 端节点数目、服务接口
- 可靠性、实时/非实时等特性

### 网络分类（按地域规模）

个域网PAN

局域网LAN

城域网MAN

广域网WAN



**网络的网络**

互连网internet：泛指网络这种类型 通用名词

互联网Internet：特指网络实例 专用名词



**互联网层级结构**



### 网络的构成

#### 网络边缘

**端系统：**

位于互联网边缘 与互联网相连的 计算机或其他设备

端系统由各类主机host构成

**主机host：**

客户端：智能手机、手环、平板电脑等智能终端

服务器：通常位于数据中心

**主机的功能：**

运行应用程序

产生信息并向接入网发送数据

从网络接收数据并提供给应用程序

**接入网概述：**



**物理介质：**

存储用字节Byte

传输用比特（位）Bit

1B=8b

引导型介质：信号在固体介质中传播

- **光纤：**高速运行 低误码率
- **双绞线：**两根绝缘铜线互相缠绕为一对
- **同轴电缆：**两根同心铜导线 双向传输

非引导型介质：信号自由传播

- 无线电
- 无线链路：无线局域网WiFi、蓝牙、卫星、地面微波



#### 网络核心

由交换机（路由器）和链路构成的网状网络。目的是将海量的端系统互联起来

**网络核心的两大功能：路由和转发**

路由：全局操作。确定数据分组从源到目标 所使用的路径

转发：本地操作。交换机（路由器）将接收到的数据分组转发出去（即移动到该设备的某个输出接口）

**电路交换：**

通常采用面向连接的方式，先呼叫连接，实现端到端的资源预留（包括 链路带宽资源，交换机的交换能力）。建立连接后，物理通路被通信双方独占，拒绝共享。由于建立连接并预留资源，英雌传输性能好，但如果传输过程中发生设备故障，则传输中断。FDM（频分多路复用） TDM（时分多路复用）

电路交换无法应对互联网中广泛存在的”突发“Burst流量

**报文交换：**

存储转发。路由器需要接收到完整的整个数据报文之后，才能开始下一跳发送。存储转发导致报文的传输延迟：L位数据报文，速率R bps发送到链路中，耗时L/R秒

**分组交换（包交换）：**

以数据分组为单位（数据传输单元），使用存储-转发机制，实现数据交互。每个分组的首部（head）都含有地址（源和目的地址）等控制信息，每个分组独立地选择传输路径，支持灵活的统计多路复用。



### 网络协议与分层结构

**网络协议：**

为进行网络中数据交换而建立的准则、标准或约定。

**层次栈：**

每层都使用下一层提供的服务，并为上一层提供自己的服务

**对等实体：**

不同机器上相应层次的实体 称为对等实体

**接口：**

相邻层次之间的接口，定义了下层向上层提供哪些服务原语

**网络体系结构：**

协议和层次的集合为网络体系结构。



发送端：层层封装

接收端：层层解封装 

连接请求 接受响应 请求数据 应答 请求断开 断开连接

**服务和协议的关系：**

- 相同层次是协议（”水平“）相邻层次是服务（”垂直“）
- 实体通过协议实现其定义的服务
- 上层实体通过接口使用下层尸体的服务

![image-20231014151258560](https://s2.loli.net/2024/01/09/nz7CojRHdFiVy5A.png)



### 网络参考模型

#### OSI 7层模型

**物理层：**信道传输0、1比特流

**数据链路层：**成帧，实现相邻网络实体间的数据传输

**网络层：**路由，将数据包通过互联网从源设备发送到目的设备

**传输层：**将数据从源端口发送到目的端口（进程到进程）

**会话层：**会话同步

**表示层：**数据表示

**应用层：**提供应用程序的网络服务调用



#### TCP/IP 4层模型

**网络接口层：**描述链路必须具备的功能

**互联网层：**数据包格式和协议

**传输层：**对等实体，端到端传输TCP UDP

**应用层：**高层协议

先有TCP/IP协议栈，然后有TCP/IP参考模型

参考模型只是用来描述协议栈的

ARPNET最终采用TCP和IP为主要协议



#### OSI模型和TCP/IP模型比较

![image-20231014153019563](https://s2.loli.net/2024/01/09/HIaA7wszeCx58l3.png)

基本设计思想：通用性与实用性

- OSI：先有模型 后设计协议。不局限与特定协议，明确了服务、协议、接口等概念，更具通用性。
- TCP/IP：先有协议栈，模型只是对已有协议的描述，更有实用性。

OSI支持面向有链接和面向无连接通信

TCP/IP只支持面向无连接通信（IP）



#### 5层网络模型

**物理层 数据链路层 网络层 传输层 应用层**



### 网络度量单位

**比特率：**

主机在数字信道上传送数据的速率，也称数据率 bps

**带宽：**

网络通道传送数据的能力。即单位时间内通道中所能通过的”最高数据率“ bit/s

**包转发率：PPS**

交换机或路由器等网络设备以包为单位的转发速率

**时延：Delay**

数据（报文或分组）从网络（或链路）的一端传送到另一端说需要的时间，也成为延迟。

- 传输时延（发送时延）：数据从节点进入到传输媒体所需要的时间
- 传播时延：电磁波在信道中传播一定距离所花费的时间
- 处理时延：主机或路由器在收到数据分组时，处理数据所花费的时间（例如分析首部、提取数据、差错检验和查找路由）
- 排队时延：数据分组在路由器输入输出队列中排队等待处理所花费的时间

$$
\begin{array}{rcl}\text{传输时延}&\\\mathrm{d_{trans}=}&\frac{\text{Length (bit)}}{\text{R(bit/s)}}\\\\\text{传播时延}&\\\mathrm{d_{prop}=}&\frac{\text{Distance (m)}}{\text{c(m/s)}}\end{array}
$$

- 往返时延RTT：从发送方发送数据开始，到发送方收到来自接收方的确认所花费的总时间。可以使用ping命令获取往返时延RTT

**时延带宽积：**

时延带宽积= 传播时延 × 带宽，即按比特计数的链路长度

**吞吐量：**

单位时间内通过某个网络（信道、接口）的数据量 bit/s

**有效吞吐量：**

单位时间内，目的地正确接收到的有用的信息的数目 bit

**利用率：**

信道利用率：信道有百分之几的时间时被利用的

网络利用率：全网络的信道利用率的平均值

**丢包率：**

丢失数据包的数量占发送数据包的比率

**时延抖动：**

变化的时延称为时延抖动。起源于网络中的队列或缓冲，难以精确预测

**延迟丢包：**

由于数据包延迟到达，接收端选择丢弃



### 重点

分组交换的优缺点

上下层之间的服务和接口，对等的协议

网络参考模型

带宽 时延 丢失率

启示：商业需求是核心驱动力，技术创新提供重要基础







## 物理层

物理层是⽹络体系结构中的最低层

**不是**连接计算机的具体物理设备

**不是**负责信号传输的具体物理媒体



### 物理层的功能

在（连接各计算机的）传输媒体上传输数据比特流，尽可能地屏蔽不同传输媒体和通信手段的差异，为数据链路层提供统一的数据传输服务。

- 数据链路层将数据比特流传输给物理层
- 物理层将数据比特流安装传输媒体的需要进行编码
- 然后将信号通过传输媒体传输到下一个节点的物理层



### 物理层接口及其特性

数据终端设备（DTE）

数据电路中介设备（DCE） 

物理层协议是DTE和DCE间的约定，规定了两者之间的接口特性

#### 机械特性：

物理机械接口（接线器）的形状和尺寸、引线数目和排列、固定和锁定装置等

#### 电气特性：



#### 功能特性：



#### 过程特性：



### 物理层常用标准

点对点通信线路：直接连接两个结点

广播通信线路：⼀条公共通信线路连接多个结点



### 物理层传输介质

传输介质是指发送器与接收器之间的物理通路

#### 导引型传输介质

双绞线、同轴电缆、光纤

#### 非引导型传输介质

电磁波无线传输 如地面微波、卫星微波、光波传输等



#### 多路复用技术

共享信道









## 数据链路层

向下：使用物理层提供的位流服务

向上：向网络层提供明确的服务接口



### 数据链路层的功能

- 成帧：将比特流划分成帧，以便检测物理层中比特传输错误
  - 网络层 分组
  - 数据链路层 成帧：头标 有效载荷 尾标
- 差错控制：信道的噪声导致数据传输问题
  - 差错：数据发送错误
  - 丢失：接收方未收到
  - 乱序：先发后到、后发先到
  - 重复：一次发送、多次接收
  - 解决方案：差错检测与纠正、确认重传
    - 确认帧：接收方检验数据后，给发送方应答，防止差错
    - 定时器：发送方启动定时器，防止丢失
    - 顺序号（序列号）：接收方检查序号，防止乱序、重复
- 流量控制：确保发送方发送速率不大于接收方处理速率
  - 避免接收缓冲区溢出
  - 解决方案
    - 反馈：接收方反馈，发送方调整发送速率
    - 速率（限速）：发送方根据内建机制，自行限速

### 数据链路层提供的服务

- 无确认无连接服务
  - 接收方不对收到的帧进行确认
  - 适用场景：误码率低的可靠信道（光纤）；实时通信
  - 网络实例：以太网
- 有确认无连接服务
  - 接收方每一帧都返回确认帧
  - 适用场景：不可靠的信道（无线信道）
  - 网络实例：802.11
- 有确认面向连接服务
  - 源机器和⽬标机器在传输任何数据之前要建⽴⼀个连接，发送的每个帧都被会被接收⽅真正接收到，并返回确认帧
  - 适用场景：高延迟的不可靠信道
  - 网络实例：卫星信道、长途电话电路





### 差错检测与纠正

#### 检错码：

- 奇偶校验：一位奇偶校验是最简单、最基础的检错码
  - 
- 校验和：主要用于TCP/IP体系中的网络层和传输层
- 循环冗余校验CRC：数据链路层广泛使用的校验方法





#### 纠错码：

m个信息位、r个校验位——纠正单比特错





















## MAC子层

### 信道分配问题

- 广播信道面临的问题

  - 可能两个（或更多）站点同时请求占用信道
- 解决办法：介质的多路访问控制
  - 多路访问信道上确定下一个使用者（信道分配）

- 怎么介质访问控制（分配信道）？
  - 静态分配
  - 动态分配



### 多路访问协议（动态分配）

![image-20231106202404995](https://s2.loli.net/2023/11/06/uWelO9ShRPrbLny.png)

#### 随机访问协议

特点：**冲突不可避免**

##### ALOHA

两个版本

- 纯ALOHA协议
  - 纯ALOHA协议工作原理：任性！
  - 特点：
    - 冲突：两个或以上的帧
    - 随时可能冲突
    - 冲突的帧完全破坏
    - 破坏了的帧要重传
- 分隙ALOHA协议
  - 分隙ALOHA (Slotted ALOHA)工作原理
    - 分隙ALOHA是把时间分成时隙（时槽）
    - 时隙的长度对应一帧的传输时间。
    - 帧的发送必须在时隙的起点。
    - 冲突只发生在时隙的起点

##### 载波侦听多路访问协议CSMA

CSMA：Carrier Sense Multiple Access
特点：“先听后发”
改进ALOHA的侦听/发送策略分类

![image-20231106150042489](https://s2.loli.net/2024/01/09/qRGf1xdhBiutLTI.png)

###### 非持续式CSMA

- 特点
  - 经侦听，如果介质空心啊，则开始发送
  - 如果介质忙，则**等待**一个随机分布的时间，然后继续侦听
- 好处
  - 等待一个随机时间，可以减少再次碰撞冲突的可能性
- 缺点
  - 等待时间内介质上如果没有数据传送，这段时间是浪费的

###### CSMA/CD （1-持续）

- 原理
  - 先听先发，边听边发

- 特点
  - 经侦听，如果介质空闲，则发送。
  - 如果介质忙，则持续侦听，一旦空闲立即发送。
  - 如果发生冲突，则等待一个随机分布的时间再重复步骤①（再次侦听）



#### 受控访问协议

- 位图协议（预留协议）
- 令牌
- 二进制倒计数协议
- 自适应树搜索协议











## 网络层（尽力而为）

网络层：实现端系统间多跳传输可达

网络层的功能：

- 路由：选择数据包从源端到目的端的路径（路由算法与协议）
- 转发：将数据包从路由器的输入接口传送到正确的输出接口

网络层功能存在每台主机和路由器中

- 发送端：将传输层数据单元封装在数据包中
- 接收端：解析接收的数据包，取出传输层数据单元，交付给传输层
- 路由器：检查数据包首部，转发数据包





###  Internet网际协议

#### IPv4

- 寻址(addressing)
- 分片(fragmentation)

IP报文长度最大为65535字节



IP协议功能及报头字段总结

网络层基本功能

- 支持多跳寻路将IP数据包送达目的端：目的IP地址
- 表明发送端身份：源IP地址
- 根据IP头部协议类型，提交给不同上层协议处理：协议

其它相关问题

- 数据包长度大于传输链路的MTU的问题，通过分片机制解决：标识、标志、片偏移
- 防止循环转发浪费网络资源（路由错误、设备故障…），通过跳数限制解决：生存时间TTL
- IP报头错误导致无效传输，通过头部校验解决：首部校验和



#### IP地址

32位：网络号+主机号

![image-20231218142118468](https://s2.loli.net/2023/12/18/UJp9x14WYPS8gtf.png)



#### ARP地址解析协议

由IP地址得到MAC地址：

- A已知B的IP地址，需要获得B的MAC地址（物理地址）
  - 如果A的ARP表中缓存有B的IP地址与MAC地址的映射关系，则直接从ARP表获取
  - 如果A的ARP表中未缓存有B的IP地址与MAC地址的映射关系，则A广播包含B的IP地址的ARP query数据包
    - 在局域网上的所有节点都可以接收到ARP query
    - B接收到ARP query数据包后，将自己的MAC地址发送给A
    - A在ARP表中缓存B的IP地址和MAC地址的映射关系
- 超时删除



#### ICMP协议
➢ICMP: 互联网控制报文协议
• ICMP 允许主机或路由器报告差错情况和提供有关异常情况的报告
• 由主机和路由器用于网络层信息的通信
• ICMP 报文携带在IP 数据包中： IP上层协议号为1
➢ICMP报文类型
• ICMP 差错报告报文
• 终点不可达：不可达主机、不可达网络，无效端口、协议
• ICMP 询问报文
• 回送请求/回答 (ping使用)





### 路由算法

Dijkstra

Bellman-Ford

#### 距离向量路由

好消息传播快，坏消息传播慢，是距离向量路由的一个主要缺点







#### 链路状态路由









重点：

距离向量和链路状态算法比较：
• 网络状态信息交换的范围
• DV:邻居间交换
• LS:全网扩散
• 网络状态信息的可靠性
• DV:部分道听途说
• LS:自己测量
• 健壮性:
• DV:计算结果传递，健壮性差
• LS: 各自计算，健壮性好
• 收敛速度：
• DV: 慢,可能有计数到无穷问题
• LS: 快



#### 层次路由







### Internet路由协议



#### OPSF-内部网关路由协议

OSPF（Open Shortest Path First）开放最短路径优先

采用**分布式的链路状态**算法



#### RIP-内部网关路由协议

路由选择协议RIP（ Routing Information Protocol）是基于距离矢量算法的协议

使用跳数衡量到达目的网络的距离
• RIP 认为一个好的路由就是它通过的路由器的数目少，即“距离短”
• RIP 允许一条路径最多只能包含 15 个路由器
➢ RIP协议的基本思想
• 仅和相邻路由器交换信息
• 路由器交换的内容是自己的路由表
• 周期性更新：30s



RIP协议的特点

- 算法简单，易于实现
- 收敛慢
- 需要交换的信息量较大
  - RIP协议的适用场合
    - 中小型网络

#### BGP-外部网关路由协议









### 路由器工作原理

控制层：路由

数据层：转发



路由器数据层
5.5 路由器工作原理
➢ 路由器中IP报文转发核心功能
• 链路层解封装，IP头部校验
• 获取报文目的IP地址
• 用目的IP地址，基于最长前缀匹配规则查询转发表
• 查询失败，丢弃报文
• 查询成功
• 获取转发出接口和下一跳IP地址
• IP头部“TTL”字段值减1，重新计算IP头部“校验和”
• 重新进行链路层封装，发送报文
注：普通IP报文转发过程中，路由器不查看传输层及以上层协议的内容
➢ IP报文在路由器转发前后的变化
• 链路层封装更新，IP头部“TTL”减1，IP头部“校验和”更新



## 传输层（有所为、有所不为）



传输层服务原理

传输层依赖网络层服务，并扩展网络层服务，将主机间交付扩展到进程间交付，通过复用和分用实现

网络通信（进程间通信） 套接字socket



### 传输层复用和分用

发送端（复用）：传输层从多个套接字收集数据，交给网络层发送

- 发送方传输层将套接字标识置于报文段中，交给网络层

接收端（分用）：传输层将从网络层收到的数据，交付给正确的套接字

- 接收方传输层根据报文段中的套接字标识，将报文段交付到正确的套接字



UDP套接字
• 使用<IP地址，端口号>二元组标识UDP套接字
• 服务器使用一个套接字服务所有客户
ØTCP套接字
• 使用<源IP地址，目的IP地址，源端口号，目的端口号> 四元
组标识连接套接字
• 服务器使用一个监听套接字和多个连接套接字服务多个客户，
每个连接套接字服务一个客户



### 无连接传输UDP





### 面向连接的传输TCP



#### TCP可靠数据传输
• 流水式发送报文段
• 采用累积确认
• 只对最早未确认的报文段使用一个重传定时器
• 超时后只重传包含最小序号的、未确认的报文段
Ø以上措施可大量减少因ACK丢失、定时器过早超时引起的重传
Ø快速重传：
• 收到3次重复确认，重发报文段



#### TCP流量控制
ØTCP接收端
• 使用显式的窗口通告，告知发送方可用的缓存空间大小
• 在接收窗口较小时，推迟发送确认
• 仅当接收窗口显著增加时，通告新的窗口大小
ØTCP发送端
• 使用Nagle算法确定发送时机
• 使用接收窗口限制发送的数据量，已发送未确认的字节数不超过接收窗
口的大小



掌握传输层服务原理 • 传输层复用和分用 • 可靠数据传输 • 流量控制 • 拥塞控制 Ø掌握因特网传输层协议： • UDP协议 • TCP协议
